---
title: Promise æœŸçº¦
createTime: 2025/04/10 22:16:52
permalink: /javascript/h5viaov5/
---

Promise æ˜¯ JavaScript ä¸­ä¸€ç§å¼‚æ­¥ç¼–ç¨‹çš„è§£å†³æ–¹æ¡ˆã€‚

åœ¨ [Promise A+](https://promisesaplus.com/) ç¤¾åŒºè§„èŒƒä¸­æœ€å…ˆå®šä¹‰äº† Promise çš„å®ç°ï¼Œå¸¦æœ‰ then æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°

åˆ° ES6 æ—¶ï¼ŒPromise è¢«çº³å…¥äº† ECMAScript æ ‡å‡†ï¼Œç»Ÿä¸€äº†ç”¨æ³•ï¼ŒåŸç”Ÿæä¾›äº† Promise æ„é€ å‡½æ•°

::: note é“¾æ¥
<https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise>
:::

## Promise è§„èŒƒ

æˆ‘ä»¬å¸¸è¯´çš„ Promise ä¸€èˆ¬æ˜¯æ»¡è¶³ Promise A+ è§„èŒƒçš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œç®€å•å¯ä»¥ç†è§£ä¸ºå¸¦æœ‰ `then` æ–¹æ³•çš„å¯¹è±¡å’Œå‡½æ•°å°±å¯ä»¥è¯´æ˜¯ä¸€ä¸ª Promiseã€‚

é€šè¿‡ `new Promise` åˆ›å»ºçš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡ä¹Ÿæ˜¯æ»¡è¶³ Promise A+ è§„èŒƒçš„çš„ä¸€ä¸ª Promiseã€‚

æ‰€ä»¥ä¸€èˆ¬åˆ¤æ–­ä¸€ä¸ªå˜é‡æ˜¯ä¸æ˜¯ä¸€ä¸ª Promiseï¼Œä¸æ˜¯é€šè¿‡ `val instanceof Promise` æ¥åˆ¤æ–­çš„ï¼Œè€Œæ˜¯å»åˆ¤æ–­å®ƒæ˜¯å¦æ»¡è¶³ Promise A+ è§„èŒƒã€‚

## å‰ç½®çŸ¥è¯†

- å‡½æ•°å¯¹è±¡ï¼šå°†å‡½æ•°ä½œä¸ºå¯¹è±¡ä½¿ç”¨
- å®ä¾‹å¯¹è±¡ï¼šé€šè¿‡ `new` æ„é€ å‡½æ•°æˆ–ç±»äº§ç”Ÿçš„å¯¹è±¡
- åŒæ­¥å›è°ƒå‡½æ•°ï¼šç«‹å³åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œä¸ä¼šæ”¾å…¥å›è°ƒé˜Ÿåˆ—ï¼Œå¦‚æ•°ç»„éå†ç›¸å…³çš„å›è°ƒ `arr.forEach(() => {})`
- å¼‚æ­¥å›è°ƒå‡½æ•°ï¼šä¸ä¼šç«‹å³æ‰§è¡Œï¼Œä¼šæ”¾å…¥**å›è°ƒé˜Ÿåˆ—**ä¸­ç­‰å¾…ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•å†æ‰§è¡Œï¼Œå¦‚å®šæ—¶å™¨ï¼Œajaxï¼ŒPromise çš„å›è°ƒ

```js
// å‡½æ•°å¯¹è±¡
function Person() {}
Person.age = 18;
console.log(Person.age);

// å®ä¾‹å¯¹è±¡
const p = new Person();
```

## å¼‚æ­¥ç¼–ç¨‹

åŒæ­¥å°±æ˜¯æŒ‰ç…§ä»£ç ä¹¦å†™çš„é¡ºåºæ‰§è¡Œï¼Œå¼‚æ­¥ä¸æŒ‰ç…§ä»£ç é¡ºåºæ‰§è¡Œï¼Œå¼‚æ­¥çš„æ‰§è¡Œæ•ˆç‡æ›´é«˜ï¼›æµè§ˆå™¨ä¸»çº¿ç¨‹ä½œä¸ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸èƒ½å¤ŸåŒæ—¶æ¥å—å¤šæ–¹é¢çš„è¯·æ±‚ã€‚æ‰€ä»¥å½“ä¸€ä¸ªäº‹ä»¶æ²¡æœ‰ç»“æŸæ—¶ï¼Œç•Œé¢å°†æ— æ³•å¤„ç†å…¶ä»–è¯·æ±‚ï¼›æˆ‘ä»¬å¸¸å¸¸ç”¨å­çº¿ç¨‹æ¥å®Œæˆä¸€äº›å¯èƒ½æ¶ˆè€—æ—¶é—´è¶³å¤Ÿé•¿ä»¥è‡³äºè¢«ç”¨æˆ·å¯Ÿè§‰çš„äº‹æƒ…ã€‚

å› ä¸ºå­çº¿ç¨‹ç‹¬ç«‹äºä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥å³ä½¿å‡ºç°é˜»å¡ä¹Ÿä¸ä¼šå½±å“ä¸»çº¿ç¨‹çš„è¿è¡Œã€‚ä½†æ˜¯å­çº¿ç¨‹æœ‰ä¸€ä¸ªå±€é™ï¼šä¸€æ—¦å‘å°„äº†ä»¥åå°±**ä¼šä¸ä¸»çº¿ç¨‹å¤±å»åŒæ­¥ï¼Œæˆ‘ä»¬æ— æ³•ç¡®å®šå®ƒçš„ç»“æŸ**ï¼Œå¦‚æœç»“æŸä¹‹åéœ€è¦å¤„ç†ä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚å¤„ç†æ¥è‡ªæœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬æ˜¯æ— æ³•å°†å®ƒåˆå¹¶åˆ°ä¸»çº¿ç¨‹ä¸­å»çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJavaScript ä¸­çš„å¼‚æ­¥æ“ä½œå‡½æ•°å¾€å¾€é€šè¿‡**å›è°ƒå‡½æ•°**æ¥å®ç°å¼‚æ­¥ä»»åŠ¡çš„ç»“æœå¤„ç†ã€‚

**å›è°ƒå‡½æ•°**å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ˜¯åœ¨æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™å°±å‘Šè¯‰å®ƒï¼šç­‰ä½ å®Œæˆäº†è¿™ä¸ªä»»åŠ¡ä¹‹åè¦å¹²ä»€ä¹ˆã€‚è¿™æ ·ä¸€æ¥ä¸»çº¿ç¨‹å‡ ä¹ä¸ç”¨å…³å¿ƒå¼‚æ­¥ä»»åŠ¡çš„çŠ¶æ€äº†ï¼Œä»–è‡ªå·±ä¼šå–„å§‹å–„ç»ˆã€‚Promise ä¹‹å‰çš„ ajax å’Œå®šæ—¶å™¨éƒ½æ˜¯å¼‚æ­¥è§£å†³æ–¹æ¡ˆã€‚

ä¾‹å¦‚ `setTimeout(callback, t)` å°±ä¼šå¯åŠ¨ä¸€ä¸ªå­çº¿ç¨‹ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°

### Promise ç±»

Promise æ˜¯ä¸€ä¸ª ES6 æä¾›çš„**ç±»**ï¼Œæˆ–è€…è¯´æ˜¯ä¸€ä¸ª**æ„é€ å‡½æ•°**ï¼Œç›®çš„æ˜¯æ›´åŠ ä¼˜é›…åœ°ä¹¦å†™å¤æ‚çš„å¼‚æ­¥ä»»åŠ¡ã€‚å°†"å‡½æ•°ç€‘å¸ƒ"å˜æˆé¡ºåºæ ¼å¼çš„ä»£ç ã€‚

> **Promise çš„å®ä¾‹å¯¹è±¡å¯ä»¥ç”¨æ¥å°è£…ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œå¹¶å¯ä»¥è·å–å…¶æˆåŠŸæˆ–å¤±è´¥çš„å€¼**

1ï¸âƒ£ èµ·å§‹å‡½æ•° `executor`

- Promise æ„é€ å‡½æ•°åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯ä¸€ä¸ª**åŒæ­¥å›è°ƒå‡½æ•°**ï¼Œè¿™ä¸ªå‡½æ•°åœ¨æ„é€ ä¹‹åä¼šç«‹å³åœ¨ä¸»çº¿ç¨‹è¢«**åŒæ­¥**è¿è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬ç§°ä¹‹ä¸º**èµ·å§‹å‡½æ•° executor** å‡½æ•°
- **èµ·å§‹å‡½æ•°**åŒ…å«ä¸¤ä¸ªå‡½æ•°å‚æ•°ï¼Œ `resolve()` å’Œ `reject()` å‡½æ•°
- åœ¨ Promise çš„ `executor` å‡½æ•°ä½“ä¸­ä¹¦å†™**å¼‚æ­¥ä»»åŠ¡**ï¼Œä¹‹åè°ƒç”¨ `resolve()` å’Œ `reject()`
- å½“è°ƒç”¨ `resolve()`ï¼Œè¡¨ç¤ºå¼‚æ­¥ä»»åŠ¡æˆåŠŸï¼ŒPromise çŠ¶æ€å˜ä¸ºæˆåŠŸæ€ï¼›`resolve()` ä¸­å¯ä»¥æ”¾ç½®ä¸€ä¸ªå‚æ•°ç”¨äºæŒ‡å®šæˆåŠŸçš„ `value` å€¼
- å½“è°ƒç”¨ `reject()`ï¼Œè¡¨ç¤ºå¼‚æ­¥ä»»åŠ¡å¤±è´¥ï¼ŒPromise çŠ¶æ€å˜ä¸ºå¤±è´¥æ€ï¼›`reject()` å‚æ•°ä¸­ä¸€èˆ¬ä¼šä¼ é€’ä¸€ä¸ªé”™è¯¯å¯¹è±¡ç”¨äºæŒ‡å®šå¤±è´¥çš„ `reason` å€¼
- `resolve()` å’Œ `reject()` çš„ä½œç”¨åŸŸåªæœ‰èµ·å§‹å‡½æ•°ï¼Œä¸åŒ…æ‹¬ `then` ä»¥åŠå…¶ä»–åºåˆ—ï¼›
- `resolve()` å’Œ `reject()` å¹¶ä¸èƒ½å¤Ÿä½¿**èµ·å§‹å‡½æ•°**åœæ­¢è¿è¡Œï¼Œå¦‚æœå¸Œæœ›èµ·å§‹å‡½æ•°åœ¨ `resolve()` ä¹‹ååœæ­¢ï¼Œåˆ«å¿˜äº† `return`ï¼›

2ï¸âƒ£ Promise å®ä¾‹çš„æ–¹æ³•

- Promise ç±»çš„åŸå‹ä¸Šæœ‰ `then` `catch` `finally` ä¸‰ä¸ªæ–¹æ³•ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•çš„å‚æ•°éƒ½æ˜¯å›è°ƒå‡½æ•°
  - `then()` ç”¨äºæŒ‡å®š Promise æˆåŠŸå’Œå¤±è´¥çš„å›è°ƒ (ä¸€èˆ¬åªæŒ‡å®šæˆåŠŸçš„å›è°ƒ)
  - `catch()` ç”¨äºæŒ‡å®š Promise å¤±è´¥æ—¶çš„å›è°ƒ
  - `finally()` ç”¨äºæŒ‡å®š Promise æœ€ç»ˆæ‰§è¡Œçš„å›è°ƒ
- `then()` ä¸­çš„å›è°ƒå‡½æ•°æ˜¯**å¼‚æ­¥å›è°ƒå‡½æ•°**ï¼Œ**then æ–¹æ³•è¿”å›ä¸€ä¸ªæ–° Promise å®ä¾‹**ï¼Œå› æ­¤å¯ä»¥ç»§ç»­**é“¾å¼è°ƒç”¨** ï¼Œè§£å†³ä¼ ç»Ÿçš„å›è°ƒåœ°ç‹±çš„é—®é¢˜

  - å¦‚æœ `then()` æŒ‡å®šçš„å›è°ƒæ‰§è¡Œåè¿”å›ä¸€ä¸ªé Promise å€¼ï¼Œå¦‚ `undefined`ï¼Œé‚£ä¹ˆæ–° Promise å®ä¾‹çš„çŠ¶æ€ä¸ºæˆåŠŸï¼Œå€¼ä¸º `undefined`
  - å¦‚æœ `then()` æŒ‡å®šçš„å›è°ƒæ‰§è¡Œåè¿”å›ä¸€ä¸ª Promise å®ä¾‹ `p`ï¼Œé‚£ä¹ˆæ–° Promise å®ä¾‹çš„çŠ¶æ€å’Œå€¼ä¸ `p` ä¸€è‡´
  - å¦‚æœ `then()` æŒ‡å®šçš„å›è°ƒæ‰§è¡ŒåæŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆæ–° Promise å®ä¾‹çš„çŠ¶æ€ä¸ºå¤±è´¥ï¼Œå€¼ä¸ºæŠ›å‡ºçš„å¼‚å¸¸

- `then()` æ–¹æ³•ä¼ å…¥ä¸¤ä¸ªå‡½æ•°å‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯æˆåŠŸçš„å›è°ƒå‡½æ•°ï¼Œç¬¬äºŒä¸ªæ˜¯å¤±è´¥çš„å›è°ƒå‡½æ•°ï¼ˆæˆ‘ä»¬ä¸€èˆ¬åªä¼ æˆåŠŸçš„å›è°ƒï¼‰
- åŸå§‹ Promise å®ä¾‹çš„**çŠ¶æ€åªèƒ½æ”¹å˜ä¸€æ¬¡**ï¼Œä» `pending` åˆ° `fulfiled` æˆ–ä» `pending` åˆ° `rejected`
- æŒ‡å®šå¤šä¸ªå¤±è´¥æˆ–æˆåŠŸçš„å›è°ƒå‡½æ•°ï¼Œéƒ½ä¼šä¾æ¬¡è°ƒç”¨ **(å›è°ƒé˜Ÿåˆ—)**ï¼Œæ³¨æ„æ˜¯å¤šä¸ª `then()` çš„å›è°ƒå‡ ä¹åŒæ—¶æ¨å…¥å›è°ƒé˜Ÿåˆ—ï¼ŒåŒæ—¶æ‰§è¡Œ

3ï¸âƒ£ å…¶ä»–

- Promise çš„**é”™è¯¯ç©¿é€**
  - å½“ä½¿ç”¨ Promise çš„ `then()` æ–¹æ³•é“¾å¼è°ƒç”¨æ—¶ï¼Œå¯ä»¥åœ¨æœ€åç”¨ `catch` æŒ‡å®šä¸€ä¸ªå¤±è´¥çš„å›è°ƒï¼›å‰é¢ä»»ä½•æ“ä½œå‡ºç°é”™è¯¯ï¼Œéƒ½ä¼šä¼ åˆ°æœ€åå¤±è´¥çš„å›è°ƒä¸­å¤„ç†
- ä»€ä¹ˆæ—¶å€™é€‚åˆç”¨ Promise è€Œä¸æ˜¯ä¼ ç»Ÿå›è°ƒå‡½æ•°ï¼Ÿ
  - å½“**éœ€è¦å¤šæ¬¡é¡ºåºæ‰§è¡Œå¼‚æ­¥æ“ä½œçš„æ—¶å€™**ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæƒ³é€šè¿‡å¼‚æ­¥æ–¹æ³•å…ˆåæ£€æµ‹ç”¨æˆ·åå’Œå¯†ç ï¼Œéœ€è¦å…ˆå¼‚æ­¥æ£€æµ‹ç”¨æˆ·åï¼Œç„¶åå†å¼‚æ­¥æ£€æµ‹å¯†ç çš„æƒ…å†µä¸‹å°±å¾ˆé€‚åˆ Promise
- Promise åªä¸è¿‡æ˜¯ä¸€ç§æ›´è‰¯å¥½çš„ç¼–ç¨‹é£æ ¼ï¼Œæ²¡æœ‰æŠŠå¼‚æ­¥è½¬æ¢ä¸ºåŒæ­¥
- ä»€ä¹ˆæ—¶å€™æˆ‘ä»¬éœ€è¦å†å†™ä¸€ä¸ª `then()` è€Œä¸æ˜¯åœ¨å½“å‰çš„ `then()` æ¥ç€ç¼–ç¨‹ï¼Ÿ
  - å½“ä½ åˆéœ€è¦è°ƒç”¨ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡çš„æ—¶å€™

### ä»£ç ç¤ºä¾‹

```js
/** ç¤ºä¾‹ 1 */
new Promise((resolve, reject) => {
  // è¦åšçš„äº‹ (åŒæ­¥ä»£ç ï¼Œé‡Œé¢å¼€å¯ä¸€äº›å¼‚æ­¥ä»»åŠ¡)
  resolve(); // or reject()
}).then(
  (value) => {}, // æˆåŠŸçš„å›è°ƒ (å¼‚æ­¥å›è°ƒ)
  (reason) => {} // å¤±è´¥çš„å›è°ƒ (å¼‚æ­¥å›è°ƒ)
);

/** ç¤ºä¾‹ 2 */
new Promise((resolve, reject) => {
  setTimeout(() => {
    console.log("First");
    resolve(); // è¡¨ç¤ºä¸€åˆ‡æ­£å¸¸ï¼Œç»§ç»­æ‰§è¡Œ
  }, 1000);
})
  .then(() => {
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        console.log("Second");
        resolve();
      }, 1000);
    });
  })
  .then(() => {
    setTimeout(() => {
      console.log("Third");
    }, 3000);
  });

/** ç¤ºä¾‹ 3 */
new Promise((resolve, reject) => {
  console.log(1111);
  resolve(2222); // è¡¨ç¤ºä¸€åˆ‡æ­£å¸¸ï¼ŒæŠŠ 2222 ä¼ é€’ç»™ä¸‹ä¸€ä¸ª then çš„ valueï¼Œç»§ç»­æ‰§è¡Œ
})
  .then((value) => {
    console.log(value);
    return 3333; // è¡¨ç¤ºä¸€åˆ‡æ­£å¸¸ï¼ŒæŠŠ 3333 ä¼ é€’ç»™ä¸‹ä¸€ä¸ª then çš„ value
  })
  .then((value) => {
    console.log(value);
    throw "An error"; // æŠ›å‡ºå¼‚å¸¸å’Œè°ƒç”¨ reject ç±»ä¼¼
  })
  .catch((err) => {
    console.log(err);
  });

// 1111 2222 3333 An error å‡ ä¹åŒæ—¶æ‰§è¡Œ

/** ç¤ºä¾‹ 4 é”™è¯¯ç©¿é€ */
const p = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject(-1);
  }, 1000);
});

p.then(
  (value) => {
    console.log("æˆåŠŸäº† 1", value);
    return "b";
  },
  // reason => { console.log('å¤±è´¥äº† 1', reason); return -2; },
  (reason) => {
    throw reason;
  } // ç³»ç»Ÿåº•å±‚è¡¥äº†è¿™ä¹ˆä¸€å¥ä»£ç ï¼ŒæŒ‡å®šå¤±è´¥çš„å›è°ƒï¼Œç”¨äºé”™è¯¯ç©¿é€
)
  .then(
    (value) => {
      console.log("æˆåŠŸäº† 2", value);
      return "c";
    },
    // reason => { console.log('å¤±è´¥äº† 2', reason); return -3; },
    (reason) => {
      throw reason;
    } // ç³»ç»Ÿåº•å±‚è¡¥äº†è¿™ä¹ˆä¸€å¥ä»£ç ï¼ŒæŒ‡å®šå¤±è´¥çš„å›è°ƒï¼Œç”¨äºé”™è¯¯ç©¿é€
  )
  .catch((reason) => {
    console.log("å¤±è´¥äº†", reason);
  });
```

## Promise å‡½æ•°

æŠŠ Promise æ”¾åœ¨å‡½æ•°çš„è¿”å›å€¼ä¸­ï¼Œè¿™æ ·å‡½æ•°å°±æˆäº†ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå¯ä»¥åœ¨è°ƒç”¨å‡½æ•°ä¹‹åä½¿ç”¨ `then` æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨ `await` ä¹‹åï¼Œç›¸å½“äºç”¨ Promise å°è£…äº†ä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚

```js
// Promise å‡½æ•° (è§£å†³å›è°ƒåœ°ç‹±)
function print(delay, message) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      console.log(message);
      resolve();
    }, delay);
  });
}

// è°ƒç”¨ Promise å‡½æ•°
print(1000, "First")
  .then(() => {
    return print(1000, "Second");
  })
  .then(function () {
    print(1000, "Third");
  });

// æ”¹å†™å¼‚æ­¥å‡½æ•°
async function asyncFunc() {
  await print(1000, "First"); // await åé¢ä¸€èˆ¬è·Ÿä¸€ä¸ª Promise å®ä¾‹å¯¹è±¡
  await print(1000, "Second");
  await print(1000, "Third");
}
asyncFunc();
```

## Async Await

å¼‚æ­¥å‡½æ•° `async function` ä¸­å¯ä»¥ä½¿ç”¨ `await` æŒ‡ä»¤ï¼Œ`await` æŒ‡ä»¤åä¸€èˆ¬è·Ÿç€ä¸€ä¸ª Promise å®ä¾‹ï¼Œå¼‚æ­¥å‡½æ•°ä¼šåœ¨è¿™ä¸ª Promise è¿è¡Œä¸­æš‚åœï¼Œç›´åˆ°å…¶è¿è¡Œç»“æŸå†ç»§ç»­è¿è¡Œã€‚

- **`async` ä¿®é¥°çš„å‡½æ•°ï¼Œå‡½æ•°çš„è¿”å›å€¼ä¸€å®šä¸º Promise å®ä¾‹**
- `async` å‡½æ•°æ— è®ºä½ è¿”å›ä»€ä¹ˆï¼Œéƒ½ä¼šè¢«è‡ªåŠ¨åŒ…è£¹æˆä¸€ä¸ªæ–°çš„ Promiseã€‚
- Promise å®ä¾‹çš„ç»“æœç”± `async` å‡½æ•°æ‰§è¡Œçš„è¿”å›å€¼å†³å®š
- `await` æŒ‡ä»¤åçš„è¡¨è¾¾å¼ä¸€èˆ¬æ˜¯ä¸€ä¸ª Promise å®ä¾‹ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒå€¼
  - å¦‚æœè¡¨è¾¾å¼æ˜¯ Promise å¯¹è±¡ï¼Œé‚£ä¹ˆ `await` åçš„è¿”å›å€¼æ˜¯ Promise æˆåŠŸçš„å€¼
  - å¦‚æœè¡¨è¾¾å¼æ˜¯ Promise å¯¹è±¡ï¼Œä¸”å¤±è´¥äº†ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œéœ€è¦é€šè¿‡ `try catch` æ¥æ•è·å¤„ç†
  - å¦‚æœè¡¨è¾¾å¼æ˜¯å…¶å®ƒå€¼ï¼Œç›´æ¥å°†æ­¤å€¼ä½œä¸º `await` çš„è¿”å›å€¼
- `await` çš„åº•å±‚åŸç†è¿˜æ˜¯å°†ä»£ç ç¿»è¯‘æˆ `then` æ–¹æ³•

```js
async function demo() {
  const result = await p;
  console.log('å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆ');
  console.log(result);
}

// åº•å±‚ç¿»è¯‘æˆ
function demo() {
  p.then(
  	result => {
      console.log('å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆ');
      console.log(result;)
    }
  )
}
```

```js
async function fn1() {
  console.log(1);
  await fn2(); // é‡åˆ° awaitï¼Œæ‰§è¡Œ fn2ï¼ˆè¿™æ˜¯ä¸ª async å‡½æ•°ï¼Œä¼šè¿”å› Promiseï¼‰ï¼Œfn2 å†…éƒ¨çš„ä»£ç æ˜¯åŒæ­¥çš„
  console.log(2); // await ä¹‹åçš„ä»£ç ä¼šæ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç­‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œå†æ‰§è¡Œ
}

async function fn2() {
  console.log("fn2"); // è¿™è¡Œæ˜¯åŒæ­¥çš„ï¼Œç«‹å³æ‰§è¡Œ
}

fn1();
console.log(3); // è¿™è¡Œæ˜¯åŒæ­¥çš„ï¼Œfn1 çš„ await åç»­éƒ¨åˆ†ä¸ä¼šé˜»å¡å®ƒ

// 1 fn2 3 2  await é˜»å¡åé¢ä»£ç çš„è¿è¡Œï¼Œå®ƒç›¸å½“äºä¸€ä¸ª Promiseï¼Œthen æ–¹æ³•ä¼šé˜»å¡

console.log(fn2()); // Promise {<fulfilled>: undefined}
```

Promise è§£å†³äº†ä¼ ç»Ÿå›è°ƒå‡½æ•°çš„å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œä½†æ˜¯å¯¼è‡´äº†çºµå‘çš„å›è°ƒé“¾ï¼Œé‡åˆ°å¤æ‚çš„ä¸šåŠ¡åœºæ™¯ä¹Ÿä¸ç¾è§‚ï¼›`async await` çš„ä»£ç æ›´ç®€æ´ï¼Œçœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ï¼Œæ˜¯åŸºäº Promise å®ç°çš„

## Promise API

### 1ï¸âƒ£ `Promise.all(PromiseArr)`

**åªæœ‰å½“æ‰€æœ‰ Promise éƒ½æˆåŠŸæ—¶ï¼Œå®ƒæ‰ä¼šæˆåŠŸï¼›å¦‚æœæœ‰ä»»ä½•ä¸€ä¸ª Promise å¤±è´¥ï¼Œå®ƒå°±ä¼šå¤±è´¥**

ä¼ å…¥åŒ…å« n ä¸ª Promise çš„æ•°ç»„ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹ï¼Œåªæœ‰**æ‰€æœ‰çš„ Promise éƒ½æˆåŠŸæ‰æˆåŠŸ**ï¼Œä¸”æˆåŠŸçš„ value æ˜¯æ‰€æœ‰ Promise æˆåŠŸçš„ value çš„æ•°ç»„ï¼Œåªè¦æœ‰ä¸€ä¸ªå¤±è´¥äº†å°±ç›´æ¥å¤±è´¥ã€‚å¹¶ä¸”åªè¦æ£€æµ‹åˆ°å¤±è´¥çš„ï¼Œå°±ç«‹å³è¿”å›å¤±è´¥çš„ Promiseã€‚

```js :collapsed-lines
// åˆ›å»ºä¸‰ä¸ª Promiseï¼Œæ¨¡æ‹Ÿä¸‰ä¸ªå¼‚æ­¥è¯·æ±‚
const p1 = new Promise((resolve) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 1 å®Œæˆ");
    resolve("æ•°æ® 1");
  }, 1000);
});

const p2 = new Promise((resolve) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 2 å®Œæˆ");
    resolve("æ•°æ® 2");
  }, 2000);
});

const p3 = new Promise((resolve) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 3 å®Œæˆ");
    resolve("æ•°æ® 3");
  }, 3000);
});

// ä½¿ç”¨ Promise.all å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰è¯·æ±‚
Promise.all([p1, p2, p3])
  .then((results) => {
    console.log("æ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸå®Œæˆï¼");
    console.log("ç»“æœæ•°ç»„:", results); // ['æ•°æ® 1', 'æ•°æ® 2', 'æ•°æ® 3']
  })
  .catch((error) => {
    console.error("æœ‰ä¸€ä¸ªè¯·æ±‚å¤±è´¥äº†:", error);
  });

// è¾“å‡ºé¡ºåº:
// è¯·æ±‚ 1 å®Œæˆ
// è¯·æ±‚ 2 å®Œæˆ
// è¯·æ±‚ 3 å®Œæˆ
// æ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸå®Œæˆï¼
// ç»“æœæ•°ç»„: ['æ•°æ® 1', 'æ•°æ® 2', 'æ•°æ® 3']
```

**å¤±è´¥ç¤ºä¾‹**:

```js
// åˆ›å»ºä¸€ä¸ªä¼šå¤±è´¥çš„ Promise
const p4 = new Promise((resolve, reject) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 4 å¤±è´¥");
    reject(new Error("è¯·æ±‚ 4 å‡ºé”™äº†"));
  }, 1500);
});

// ä½¿ç”¨ Promise.all å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰è¯·æ±‚ï¼ŒåŒ…æ‹¬ä¸€ä¸ªä¼šå¤±è´¥çš„è¯·æ±‚
Promise.all([p1, p2, p4])
  .then((results) => {
    console.log("æ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸå®Œæˆï¼");
    console.log("ç»“æœæ•°ç»„:", results);
  })
  .catch((error) => {
    console.error("æœ‰ä¸€ä¸ªè¯·æ±‚å¤±è´¥äº†:", error);
  });

// è¾“å‡ºé¡ºåº:
// è¯·æ±‚ 1 å®Œæˆ
// è¯·æ±‚ 4 å¤±è´¥
// æœ‰ä¸€ä¸ªè¯·æ±‚å¤±è´¥äº†: Error: è¯·æ±‚ 4 å‡ºé”™äº†
// æ³¨æ„: p2 å’Œ p3 è™½ç„¶æœ€ç»ˆä¼šå®Œæˆï¼Œä½† Promise.all åœ¨æ£€æµ‹åˆ°ç¬¬ä¸€ä¸ªå¤±è´¥æ—¶å°±ç«‹å³è¿”å›äº†
```

### 2ï¸âƒ£ `Promise.any(PromiseArr)`

**åªè¦å…¶ä¸­ä¸€ä¸ª Promise æˆåŠŸï¼Œè¿”å›çš„ Promise å°±ä¼šæˆåŠŸï¼›å¦‚æœæ‰€æœ‰çš„ Promise éƒ½å¤±è´¥ï¼Œåˆ™è¿”å›å¤±è´¥**

```js :collapsed-lines
// åˆ›å»ºä¸‰ä¸ª Promiseï¼Œæ¨¡æ‹Ÿä¸‰ä¸ªå¼‚æ­¥è¯·æ±‚
const p1 = new Promise((resolve, reject) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 1 å¤±è´¥");
    reject(new Error("è¯·æ±‚ 1 å‡ºé”™äº†"));
  }, 1000);
});

const p2 = new Promise((resolve) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 2 æˆåŠŸ");
    resolve("æ•°æ® 2");
  }, 2000);
});

const p3 = new Promise((resolve, reject) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 3 å¤±è´¥");
    reject(new Error("è¯·æ±‚ 3 å‡ºé”™äº†"));
  }, 3000);
});

// ä½¿ç”¨ Promise.any å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰è¯·æ±‚
Promise.any([p1, p2, p3])
  .then((result) => {
    console.log("è‡³å°‘æœ‰ä¸€ä¸ªè¯·æ±‚æˆåŠŸå®Œæˆï¼");
    console.log("ç¬¬ä¸€ä¸ªæˆåŠŸçš„ç»“æœ:", result); // 'æ•°æ® 2'
  })
  .catch((error) => {
    console.error("æ‰€æœ‰è¯·æ±‚éƒ½å¤±è´¥äº†:", error);
  });

// è¾“å‡ºé¡ºåº:
// è¯·æ±‚ 1 å¤±è´¥
// è¯·æ±‚ 2 æˆåŠŸ
// è‡³å°‘æœ‰ä¸€ä¸ªè¯·æ±‚æˆåŠŸå®Œæˆï¼
// ç¬¬ä¸€ä¸ªæˆåŠŸçš„ç»“æœ: æ•°æ® 2
// æ³¨æ„: è¯·æ±‚ 3 è™½ç„¶æœ€ç»ˆä¼šå¤±è´¥ï¼Œä½† Promise.any åœ¨æ£€æµ‹åˆ°ç¬¬ä¸€ä¸ªæˆåŠŸæ—¶å°±ç«‹å³è¿”å›äº†
```

**å…¨éƒ¨å¤±è´¥ç¤ºä¾‹**:

```js :collapsed-lines
// åˆ›å»ºä¸‰ä¸ªéƒ½ä¼šå¤±è´¥çš„ Promise
const p4 = new Promise((resolve, reject) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 4 å¤±è´¥");
    reject(new Error("è¯·æ±‚ 4 å‡ºé”™äº†"));
  }, 1000);
});

const p5 = new Promise((resolve, reject) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 5 å¤±è´¥");
    reject(new Error("è¯·æ±‚ 5 å‡ºé”™äº†"));
  }, 2000);
});

const p6 = new Promise((resolve, reject) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 6 å¤±è´¥");
    reject(new Error("è¯·æ±‚ 6 å‡ºé”™äº†"));
  }, 3000);
});

// ä½¿ç”¨ Promise.any å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰è¯·æ±‚
Promise.any([p4, p5, p6])
  .then((result) => {
    console.log("è‡³å°‘æœ‰ä¸€ä¸ªè¯·æ±‚æˆåŠŸå®Œæˆï¼");
    console.log("ç¬¬ä¸€ä¸ªæˆåŠŸçš„ç»“æœ:", result);
  })
  .catch((error) => {
    console.error("æ‰€æœ‰è¯·æ±‚éƒ½å¤±è´¥äº†:", error);
    console.log("é”™è¯¯ç±»å‹:", error.name); // AggregateError
    console.log("æ‰€æœ‰é”™è¯¯:", error.errors); // [Error: è¯·æ±‚ 4 å‡ºé”™äº†, Error: è¯·æ±‚ 5 å‡ºé”™äº†, Error: è¯·æ±‚ 6 å‡ºé”™äº†]
  });

// è¾“å‡ºé¡ºåº:
// è¯·æ±‚ 4 å¤±è´¥
// è¯·æ±‚ 5 å¤±è´¥
// è¯·æ±‚ 6 å¤±è´¥
// æ‰€æœ‰è¯·æ±‚éƒ½å¤±è´¥äº†: AggregateError: All promises were rejected
// é”™è¯¯ç±»å‹: AggregateError
// æ‰€æœ‰é”™è¯¯: [Error: è¯·æ±‚ 4 å‡ºé”™äº†, Error: è¯·æ±‚ 5 å‡ºé”™äº†, Error: è¯·æ±‚ 6 å‡ºé”™äº†]
```

### 3ï¸âƒ£ `Promise.allSettled(PromiseArr)`

**ç­‰å¾…æ‰€æœ‰ Promise éƒ½å®Œæˆï¼ˆæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªåŒ…å«æ¯ä¸ª Promise ç»“æœçš„æ•°ç»„**

æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œstatus å­—æ®µè¡¨ç¤ºçŠ¶æ€ï¼Œvalue è¡¨ç¤ºæˆåŠŸçš„å€¼ï¼Œreason è¡¨ç¤ºå¤±è´¥çš„åŸå› 

```js
[
  { status: 'fulfilled', value: 1 },
  { status: 'fulfilled', value: 2 },
  {
    status: 'rejected',
    reason: Error: å‡ºé”™äº†ï¼Œå‡ºé”™è¯·æ±‚ï¼š92
        at Timeout._onTimeout (/Users/code/è¯·æ±‚å¹¶å‘.js:13:20)
        at listOnTimeout (node:internal/timers:569:17)
        at process.processTimers (node:internal/timers:512:7)
  },
]
```

```js :collapsed-lines
// åˆ›å»ºä¸‰ä¸ª Promiseï¼Œæ¨¡æ‹Ÿä¸‰ä¸ªå¼‚æ­¥è¯·æ±‚
const p1 = new Promise((resolve) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 1 å®Œæˆ");
    resolve("æ•°æ® 1");
  }, 1000);
});

const p2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 2 å¤±è´¥");
    reject(new Error("è¯·æ±‚ 2 å‡ºé”™äº†"));
  }, 2000);
});

const p3 = new Promise((resolve) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 3 å®Œæˆ");
    resolve("æ•°æ® 3");
  }, 3000);
});

// ä½¿ç”¨ Promise.allSettled å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰è¯·æ±‚
Promise.allSettled([p1, p2, p3]).then((results) => {
  console.log("æ‰€æœ‰è¯·æ±‚éƒ½å·²å®Œæˆï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼‰ï¼");
  console.log("ç»“æœæ•°ç»„:", results);

  // å¤„ç†ç»“æœ
  results.forEach((result, index) => {
    if (result.status === "fulfilled") {
      console.log(`è¯·æ±‚ ${index + 1} æˆåŠŸï¼Œå€¼ä¸º: ${result.value}`);
    } else {
      console.log(`è¯·æ±‚ ${index + 1} å¤±è´¥ï¼ŒåŸå› ä¸º: ${result.reason.message}`);
    }
  });
});

// è¾“å‡ºé¡ºåº:
// è¯·æ±‚ 1 å®Œæˆ
// è¯·æ±‚ 2 å¤±è´¥
// è¯·æ±‚ 3 å®Œæˆ
// æ‰€æœ‰è¯·æ±‚éƒ½å·²å®Œæˆï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼‰ï¼
// ç»“æœæ•°ç»„: [
//   { status: 'fulfilled', value: 'æ•°æ® 1' },
//   { status: 'rejected', reason: Error: è¯·æ±‚ 2 å‡ºé”™äº† },
//   { status: 'fulfilled', value: 'æ•°æ® 3' }
// ]
// è¯·æ±‚ 1 æˆåŠŸï¼Œå€¼ä¸º: æ•°æ® 1
// è¯·æ±‚ 2 å¤±è´¥ï¼ŒåŸå› ä¸º: è¯·æ±‚ 2 å‡ºé”™äº†
// è¯·æ±‚ 3 æˆåŠŸï¼Œå€¼ä¸º: æ•°æ® 3
```

### 4ï¸âƒ£ `Promise.race(PromiseArr)`

åªè¦ä¼ å…¥çš„ Promise æ•°ç»„ä¸­ **æœ‰ä¸€ä¸ª Promise ç‡å…ˆå˜ä¸º fulfilled æˆ– rejected**ï¼Œrace è¿”å›çš„è¿™ä¸ª Promise å°±ä¼šä»¥ç›¸åŒçš„çŠ¶æ€å®Œæˆï¼ˆä¸ç®¡åé¢çš„ Promise æœ‰æ²¡æœ‰å®Œæˆï¼‰ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œ**ç¬¬ä¸€ä¸ªå®Œæˆï¼ˆæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰çš„ Promise çš„ç»“æœï¼Œå°±æ˜¯æœ€ç»ˆçš„ç»“æœ**ã€‚

```js :collapsed-lines
// åˆ›å»ºä¸‰ä¸ª Promiseï¼Œæ¨¡æ‹Ÿä¸‰ä¸ªå¼‚æ­¥è¯·æ±‚
const p1 = new Promise((resolve) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 1 å®Œæˆ");
    resolve("æ•°æ® 1");
  }, 1000);
});

const p2 = new Promise((resolve) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 2 å®Œæˆ");
    resolve("æ•°æ® 2");
  }, 2000);
});

const p3 = new Promise((resolve) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 3 å®Œæˆ");
    resolve("æ•°æ® 3");
  }, 3000);
});

// ä½¿ç”¨ Promise.race å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰è¯·æ±‚
Promise.race([p1, p2, p3])
  .then((result) => {
    console.log("æœ‰ä¸€ä¸ªè¯·æ±‚ç‡å…ˆå®Œæˆï¼");
    console.log("ç¬¬ä¸€ä¸ªå®Œæˆçš„ç»“æœ:", result); // 'æ•°æ® 1'
  })
  .catch((error) => {
    console.error("æœ‰ä¸€ä¸ªè¯·æ±‚ç‡å…ˆå¤±è´¥:", error);
  });

// è¾“å‡ºé¡ºåº:
// è¯·æ±‚ 1 å®Œæˆ
// æœ‰ä¸€ä¸ªè¯·æ±‚ç‡å…ˆå®Œæˆï¼
// ç¬¬ä¸€ä¸ªå®Œæˆçš„ç»“æœ: æ•°æ® 1
// æ³¨æ„: è¯·æ±‚ 2 å’Œè¯·æ±‚ 3 è™½ç„¶æœ€ç»ˆä¼šå®Œæˆï¼Œä½† Promise.race åœ¨æ£€æµ‹åˆ°ç¬¬ä¸€ä¸ªå®Œæˆæ—¶å°±ç«‹å³è¿”å›äº†
```

**å¤±è´¥ç¤ºä¾‹**:

```js
// åˆ›å»ºä¸€ä¸ªä¼šå¤±è´¥çš„ Promise
const p4 = new Promise((resolve, reject) => {
  setTimeout(() => {
    console.log("è¯·æ±‚ 4 å¤±è´¥");
    reject(new Error("è¯·æ±‚ 4 å‡ºé”™äº†"));
  }, 500);
});

// ä½¿ç”¨ Promise.race å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰è¯·æ±‚ï¼ŒåŒ…æ‹¬ä¸€ä¸ªä¼šå¤±è´¥çš„è¯·æ±‚
Promise.race([p1, p2, p4])
  .then((result) => {
    console.log("æœ‰ä¸€ä¸ªè¯·æ±‚ç‡å…ˆå®Œæˆï¼");
    console.log("ç¬¬ä¸€ä¸ªå®Œæˆçš„ç»“æœ:", result);
  })
  .catch((error) => {
    console.error("æœ‰ä¸€ä¸ªè¯·æ±‚ç‡å…ˆå¤±è´¥:", error);
  });

// è¾“å‡ºé¡ºåº:
// è¯·æ±‚ 4 å¤±è´¥
// æœ‰ä¸€ä¸ªè¯·æ±‚ç‡å…ˆå¤±è´¥: Error: è¯·æ±‚ 4 å‡ºé”™äº†
// æ³¨æ„: è¯·æ±‚ 1 å’Œè¯·æ±‚ 2 è™½ç„¶æœ€ç»ˆä¼šå®Œæˆï¼Œä½† Promise.race åœ¨æ£€æµ‹åˆ°ç¬¬ä¸€ä¸ªå®Œæˆï¼ˆæ— è®ºæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰æ—¶å°±ç«‹å³è¿”å›äº†
```

### 5ï¸âƒ£ `Promise.resolve()`

**ç”¨äºå¿«é€Ÿè¿”å›ä¸€ä¸ªçŠ¶æ€ä¸º fulfilled çš„ Promise å®ä¾‹å¯¹è±¡**

- å°†å€¼è½¬æ¢ä¸ºå·²è§£å†³çš„ Promiseã€‚å¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ªæ™®é€šå€¼ï¼Œ`Promise.resolve` ä¼šè¿”å›ä¸€ä¸ªå·²è§£å†³çš„ Promiseï¼Œè§£æå€¼ä¸ºè¯¥æ™®é€šå€¼
- **ä¿æŒåŸæœ‰çš„ Promiseã€‚**å¦‚æœä¼ å…¥çš„å€¼å·²ç»æ˜¯ä¸€ä¸ª Promiseï¼Œ`Promise.resolve` ä¼šç›´æ¥è¿”å›è¿™ä¸ª Promiseï¼Œä¸åšä»»ä½•ä¿®æ”¹
- å¤„ç† `thenable` å¯¹è±¡ã€‚å¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ª `thenable` å¯¹è±¡ï¼ˆå³å…·æœ‰ `then` æ–¹æ³•çš„å¯¹è±¡ï¼‰ï¼Œ`Promise.resolve` ä¼šè¿”å›ä¸€ä¸ªè·Ÿè¸ªè¿™ä¸ª `thenable` å¯¹è±¡æœ€ç»ˆçŠ¶æ€çš„ Promise

```js :collapsed-lines
// ç¤ºä¾‹ 1: å°†æ™®é€šå€¼è½¬æ¢ä¸º Promise
const p1 = Promise.resolve(42);
console.log(p1); // Promise { <fulfilled>: 42 }

p1.then((value) => {
  console.log("Promise å·²è§£å†³ï¼Œå€¼ä¸º:", value); // Promise å·²è§£å†³ï¼Œå€¼ä¸º: 42
});

// ç¤ºä¾‹ 2: ä¿æŒåŸæœ‰çš„ Promise
const originalPromise = new Promise((resolve) => {
  setTimeout(() => {
    resolve("åŸå§‹ Promise çš„ç»“æœ");
  }, 1000);
});

const p2 = Promise.resolve(originalPromise);
console.log(p2); // Promise { <pending> }

p2.then((value) => {
  console.log("Promise å·²è§£å†³ï¼Œå€¼ä¸º:", value); // Promise å·²è§£å†³ï¼Œå€¼ä¸º: åŸå§‹ Promise çš„ç»“æœ
});

// ç¤ºä¾‹ 3: å¤„ç† thenable å¯¹è±¡
const thenable = {
  then: (resolve, reject) => {
    setTimeout(() => {
      resolve("thenable å¯¹è±¡çš„ç»“æœ");
    }, 1000);
  },
};

const p3 = Promise.resolve(thenable);
console.log(p3); // Promise { <pending> }

p3.then((value) => {
  console.log("Promise å·²è§£å†³ï¼Œå€¼ä¸º:", value); // Promise å·²è§£å†³ï¼Œå€¼ä¸º: thenable å¯¹è±¡çš„ç»“æœ
});

// ç¤ºä¾‹ 4: åœ¨å¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨
async function fetchData() {
  // æ¨¡æ‹Ÿå¼‚æ­¥è¯·æ±‚
  const data = await Promise.resolve({ id: 1, name: "æµ‹è¯•æ•°æ®" });
  console.log("è·å–åˆ°çš„æ•°æ®:", data);
  return data;
}

fetchData().then((result) => {
  console.log("å‡½æ•°è¿”å›ç»“æœ:", result);
});
// è¾“å‡º:
// è·å–åˆ°çš„æ•°æ®: { id: 1, name: 'æµ‹è¯•æ•°æ®' }
// å‡½æ•°è¿”å›ç»“æœ: { id: 1, name: 'æµ‹è¯•æ•°æ®' }
```

### 6ï¸âƒ£ `Promise.reject()`

**ç”¨äºå¿«é€Ÿè¿”å›ä¸€ä¸ªçŠ¶æ€ä¸º rejected çš„ Promise å®ä¾‹å¯¹è±¡**

```js :collapsed-lines
// ç¤ºä¾‹ 1: åˆ›å»ºä¸€ä¸ªè¢«æ‹’ç»çš„ Promise
const p1 = Promise.reject(new Error("æ“ä½œå¤±è´¥"));
console.log(p1); // Promise { <rejected>: Error: æ“ä½œå¤±è´¥ }

p1.catch((error) => {
  console.log("Promise è¢«æ‹’ç»ï¼Œé”™è¯¯ä¸º:", error.message); // Promise è¢«æ‹’ç»ï¼Œé”™è¯¯ä¸º: æ“ä½œå¤±è´¥
});

// ç¤ºä¾‹ 2: åœ¨å¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨
async function fetchData() {
  try {
    // æ¨¡æ‹Ÿå¼‚æ­¥è¯·æ±‚å¤±è´¥
    const data = await Promise.reject(new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥"));
    return data;
  } catch (error) {
    console.log("æ•è·åˆ°é”™è¯¯:", error.message);
    return null;
  }
}

fetchData().then((result) => {
  console.log("å‡½æ•°è¿”å›ç»“æœ:", result); // å‡½æ•°è¿”å›ç»“æœ: null
});

// ç¤ºä¾‹ 3: åœ¨æ¡ä»¶åˆ¤æ–­ä¸­ä½¿ç”¨
function processData(data) {
  if (!data) {
    return Promise.reject(new Error("æ•°æ®ä¸èƒ½ä¸ºç©º"));
  }

  return Promise.resolve(data);
}

processData(null)
  .then((result) => {
    console.log("å¤„ç†ç»“æœ:", result);
  })
  .catch((error) => {
    console.log("å¤„ç†å¤±è´¥:", error.message); // å¤„ç†å¤±è´¥: æ•°æ®ä¸èƒ½ä¸ºç©º
  });

processData({ id: 1, name: "æµ‹è¯•æ•°æ®" })
  .then((result) => {
    console.log("å¤„ç†ç»“æœ:", result); // å¤„ç†ç»“æœ: { id: 1, name: 'æµ‹è¯•æ•°æ®' }
  })
  .catch((error) => {
    console.log("å¤„ç†å¤±è´¥:", error.message);
  });

// è¾“å‡º:
// Promise { <rejected>: Error: æ“ä½œå¤±è´¥ }
// Promise è¢«æ‹’ç»ï¼Œé”™è¯¯ä¸º: æ“ä½œå¤±è´¥
// æ•è·åˆ°é”™è¯¯: ç½‘ç»œè¯·æ±‚å¤±è´¥
// å‡½æ•°è¿”å›ç»“æœ: null
// å¤„ç†å¤±è´¥: æ•°æ®ä¸èƒ½ä¸ºç©º
// å¤„ç†ç»“æœ: { id: 1, name: 'æµ‹è¯•æ•°æ®' }
```

## é¢è¯•é¢˜

### å·¥å…·å‡½æ•°

```js
// catch æ–¹æ³•
Promise.prototype.catch = function (onRejected) {
  return this.then(undefined, onRejected);
};

// resolve æ–¹æ³•
Promise.resolve = function (value) {
  // 1. å¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ª Promiseï¼Œåˆ™ç›´æ¥è¿”å›
  if (value instanceof Promise) {
    return value;
  }

  // 2. å¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ª thenable å¯¹è±¡ï¼Œåˆ™è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œå¹¶è·Ÿè¸ªå…¶çŠ¶æ€
  if (
    (typeof value === "object" || typeof value === "function") &&
    value !== null &&
    typeof value.then === "function"
  ) {
    return new Promise((resolve, reject) => {
      value.then(resolve, reject);
    });
  }

  // 3. å¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ªæ™®é€šå€¼ï¼Œåˆ™è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œå¹¶å°†å…¶çŠ¶æ€è®¾ç½®ä¸º fulfilled
  return new Promise((resolve) => {
    resolve(value);
  });
};

// reject æ–¹æ³•
Promise.reject = function (reason) {
  return new Promise((resolve, reject) => {
    reject(reason);
  });
};
```

### æ‰‹åŠ¨å®ç° Promise.all()

```js
const myPromiseAll = (arr) => {
  // æ£€æŸ¥ä¼ å…¥çš„æ˜¯å¦ä¸ºä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡
  if (!Array.isArray(arr)) {
    return Promise.reject(new TypeError("Argument must be an iterable"));
  }

  // è¿”å›ä¸€ä¸ªæ–°çš„ Promise
  return new Promise((resolve, reject) => {
    const results = []; // å®šä¹‰ç»“æœæ•°ç»„
    let count = 0; // å®šä¹‰å˜é‡å­˜å‚¨å®Œæˆçš„ Promise æ•°é‡

    // å¦‚æœæ˜¯ç©ºæ•°ç»„
    if (arr.length === 0) {
      return resolve(results);
    }

    // å¾ªç¯éå† Promise æ•°ç»„
    arr.forEach((item, index) => {
      // ä½¿ç”¨ Promise.resolve ç¡®ä¿æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ª Promiseï¼Œå› ä¸ºæ•°ç»„ä¸­ä¼ å…¥çš„å¯èƒ½ä¸æ˜¯ Promiseï¼Œè€Œæ˜¯ä¸€ä¸ªå€¼
      Promise.resolve(item)
        .then((value) => {
          results[index] = value; // ä¿è¯è¿”å›ç»“æœçš„æ•°ç»„é¡ºåºä¸å˜
          count++;

          // å¦‚æœæ‰€æœ‰çš„ Promise éƒ½å®Œæˆï¼Œåˆ™è¿”å›è§£å†³çš„ Promise
          if (count === arr.length) {
            resolve(results);
          }
        })
        .catch((reason) => {
          reject(reason); // å¦‚æœæœ‰ä¸€ä¸ª Promise è¢«æ‹’ç»ï¼Œåˆ™è¿”å›æ‹’ç»çš„ Promise
        });
    });
  });
};
```

### æ³¨æ„ç‚¹

ä¸ºä»€ä¹ˆ `p2 !== p1`ï¼Œæ˜æ˜ `async1` è¿”å›çš„æ˜¯ `p1` å‘¢ï¼Ÿ

å…³é”®ç‚¹åœ¨äº `async` å‡½æ•°çš„è¿”å›å€¼ï¼Œ`async` å‡½æ•°æ— è®ºä½ è¿”å›ä»€ä¹ˆï¼Œéƒ½ä¼šè¢«è‡ªåŠ¨åŒ…è£¹æˆä¸€ä¸ªæ–°çš„ Promiseã€‚

```js
const p1 = Promise.resolve();

async function async1() {
  return p1;
}

const p2 = async1();
console.log(p1 === p2); // false

// è§£é‡Š
async function async1() {
  return p1;
}

// ç­‰ä»·äº
async function async1() {
  return new Promise((resolve) => {
    resolve(p1);
  });
}
```

### çŠ¶æ€å¸æ”¶ (weird)

å¦‚æœä½ ç”¨ new Promise çš„ resolve() æˆ– reject() ä¼ å…¥çš„æ˜¯å¦ä¸€ä¸ª Promiseï¼Œé‚£è¿™ä¸ª Promise çš„æœ€ç»ˆçŠ¶æ€å°±ä¼šâ€œè·Ÿéšâ€è¿™ä¸ªä¼ å…¥çš„ Promiseï¼Œä¹Ÿå°±æ˜¯â€œå¸æ”¶â€å®ƒçš„çŠ¶æ€ã€‚

```js
// ç¤ºä¾‹ 1
const p1 = new Promise((resolve) => {
  resolve();
});

const p2 = new Promise((resolve) => {
  resolve(p1);
});

console.log(p1); // Promise { <fulfilled>: undefined }
console.log(p2); // Promise { <pending> }
```

p1 åœ¨ executor å‡½æ•°ä¸­åŒæ­¥æ‰§è¡Œäº† `resolve()`ï¼Œæ‰€ä»¥æ‰“å° p1 çš„çŠ¶æ€æ˜¯ `fulfilled`

p2 åœ¨ executor å‡½æ•°ä¸­åŒæ­¥æ‰§è¡Œäº† `resolve(p1)`ï¼Œä¼ å…¥äº†ä¸€ä¸ª Promiseï¼Œp2 éœ€è¦ç­‰å¾… p1 çš„çŠ¶æ€å˜åŒ–ç»“æŸæ‰ç®—æ‰§è¡Œå®Œæˆï¼Œæ‰€ä»¥åœ¨åŒæ­¥æ‰“å°çš„æ—¶å€™ p2 çš„çŠ¶æ€æ˜¯ `pending`

### ä¸€é“ç¦»è°±çš„ Promise é¢è¯•é¢˜

```js
Promise.resolve() // pr1
  .then(() => {
    // p0
    console.log(0);
    return Promise.resolve(4); // p4
  })
  .then((res) => {
    // pres
    console.log(res);
  });

Promise.resolve() // pr2
  .then(() => {
    // p1
    console.log(1);
  })
  .then(() => {
    // p2
    console.log(2);
  })
  .then(() => {
    // p3
    console.log(3);
  })
  .then(() => {
    // p5
    console.log(5);
  })
  .then(() => {
    // p6
    console.log(6);
  });

// è¾“å‡ºé¡ºåºï¼š0 1 2 3 4 5 6
```

**åˆ†æ**

1. æ‰§è¡Œ `Promise.resolve()`ã€‚ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹å¯¹è±¡ï¼Œè®°ä¸º `pr1`ï¼ŒçŠ¶æ€ä¸º `fulfilled`ï¼Œå€¼ä¸º `undefined`
2. æ‰§è¡Œ `pr1.then()`ã€‚ ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹å¯¹è±¡ï¼Œè®°ä¸º `p0`ï¼ŒçŠ¶æ€ä¸º `pending`ï¼Œå€¼ä¸º `undefined`
   - ä¸ºä»€ä¹ˆè¿™ä¸ª `p0` çš„çŠ¶æ€æ˜¯ `pending` å‘¢ï¼Ÿå› ä¸º `p0` çš„çŠ¶æ€ç”± `pr1.then()` çš„å›è°ƒå‡½æ•°å†³å®šï¼Œè€Œ `pr1.then()` çš„å›è°ƒå‡½æ•°è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œæ‰€ä»¥ `p0` çš„çŠ¶æ€æ˜¯ `pending`
   - åœ¨æ‰§è¡Œ `pr1.then()` æ—¶ï¼Œç”±äº `pr1` çš„çŠ¶æ€æ˜¯ `fulfilled`ï¼Œæ‰€ä»¥è¿™é‡Œçš„å›è°ƒå‡½æ•°ä¼šè¢«åŠ å…¥åˆ°å¾®é˜Ÿåˆ—æ’é˜Ÿæ‰§è¡Œ
   - å¾®é˜Ÿåˆ—ï¼š `0`
3. æ‰§è¡Œ `p0.then()`ã€‚ ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹å¯¹è±¡ï¼Œè®°ä¸º `pres`ï¼ŒçŠ¶æ€ä¸º `pending`ï¼Œå€¼ä¸º `undefined`
   - å¾®é˜Ÿåˆ—ï¼š `0`
4. æ‰§è¡Œç¬¬äºŒä¸ª `Promise.resolve()`ã€‚ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹å¯¹è±¡ï¼Œè®°ä¸º `pr2`ï¼ŒçŠ¶æ€ä¸º `fulfilled`ï¼Œå€¼ä¸º `undefined`
5. æ‰§è¡Œ `pr2.then()`ã€‚ ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹å¯¹è±¡ï¼Œè®°ä¸º `p1`ï¼ŒçŠ¶æ€ä¸º `pending`ï¼Œå€¼ä¸º `undefined`
   - æ‰§è¡Œ `pr2.then()` æ—¶ï¼Œç”±äº `pr2` çš„çŠ¶æ€æ˜¯ `fulfilled`ï¼Œæ‰€ä»¥è¿™é‡Œçš„å›è°ƒå‡½æ•°ä¼šè¢«åŠ å…¥åˆ°å¾®é˜Ÿåˆ—æ’é˜Ÿæ‰§è¡Œ
   - å¾®é˜Ÿåˆ—ï¼š `0` `1`
6. æ‰§è¡Œ `p1.then()`ã€‚ ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹å¯¹è±¡ï¼Œè®°ä¸º `p2`ï¼ŒçŠ¶æ€ä¸º `pending`ï¼Œå€¼ä¸º `undefined`
   - å¾®é˜Ÿåˆ—ï¼š `0` `1`
7. æ‰§è¡Œ `p2.then()`ã€‚ ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹å¯¹è±¡ï¼Œè®°ä¸º `p3`ï¼ŒçŠ¶æ€ä¸º `pending`ï¼Œå€¼ä¸º `undefined`
   - å¾®é˜Ÿåˆ—ï¼š `0` `1`
8. æ‰§è¡Œ `p3.then()`ã€‚ ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹å¯¹è±¡ï¼Œè®°ä¸º `p5`ï¼ŒçŠ¶æ€ä¸º `pending`ï¼Œå€¼ä¸º `undefined`
   - å¾®é˜Ÿåˆ—ï¼š `0` `1`
9. æ‰§è¡Œ `p5.then()`ã€‚ ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promise å®ä¾‹å¯¹è±¡ï¼Œè®°ä¸º `p6`ï¼ŒçŠ¶æ€ä¸º `pending`ï¼Œå€¼ä¸º `undefined`
   - å¾®é˜Ÿåˆ—ï¼š `0` `1`

**åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—**

- æ­¤æ—¶ Promise çŠ¶æ€
  - pr1 fulfilled
  - p0 pending
  - pres pending
  - pr2 fulfilled
  - p1 pending
  - p2 pending
  - p3 pending
  - p5 pending
  - p6 pending
- å¾®é˜Ÿåˆ—ï¼š `0` `1`

10. è¾“å‡º 0ï¼Œä¹‹åæ‰§è¡Œ `return Promise.resolve(4);`ï¼Œç”±äºè¿™é‡Œè¿”å›çš„æ˜¯ä¸€ä¸ª Promise `p4`ï¼Œæ ¹æ®è§„èŒƒï¼Œæ­¤å¤„ä¼šè°ƒç”¨ `p4.then()`ï¼Œå¹¶åœ¨å›è°ƒä¸­å®Œæˆ `p0`ã€‚ä»¥ä¸Šæ“ä½œåœ¨å¾®é˜Ÿåˆ—ä¸­æ‰§è¡Œï¼Œå› æ­¤å¦‚ä¸‹ï¼š
    - å¾®é˜Ÿåˆ—ï¼š `1` `p4.then(() => å®Œæˆ p0)`
    - è¾“å‡ºï¼š `0`
    - æ­¤æ—¶ `p0` çš„çŠ¶æ€ä¾ç„¶ä¸º `pending`
11. è¾“å‡º 1ï¼Œ`p1` çš„çŠ¶æ€å˜ä¸º `fulfilled`ï¼ŒæŠŠ `p1.then()` çš„å›è°ƒåŠ å…¥åˆ°å¾®é˜Ÿåˆ—
    - å¾®é˜Ÿåˆ—ï¼š `p4.then(() => å®Œæˆ p0)` `2`
    - è¾“å‡ºï¼š `0` `1`
12. æ‰§è¡Œ `p4.then(() => å®Œæˆ p0)`ï¼Œç›¸å½“äºæŠŠ `() => å®Œæˆ p0` åŠ å…¥åˆ°å¾®é˜Ÿåˆ—
    - å¾®é˜Ÿåˆ—ï¼š `2` `() => å®Œæˆ p0`
    - è¾“å‡ºï¼š `0` `1`
13. è¾“å‡º 2ï¼Œ`p2` çš„çŠ¶æ€å˜ä¸º `fulfilled`ï¼ŒæŠŠ `p2.then()` çš„å›è°ƒåŠ å…¥åˆ°å¾®é˜Ÿåˆ—
    - å¾®é˜Ÿåˆ—ï¼š `() => å®Œæˆ p0` `3`
    - è¾“å‡ºï¼š `0` `1` `2`
14. æ‰§è¡Œ `() => å®Œæˆ p0`ï¼Œ`p0` çš„çŠ¶æ€å˜ä¸º `fulfilled`ï¼ŒæŠŠ `p0.then()` çš„å›è°ƒåŠ å…¥åˆ°å¾®é˜Ÿåˆ—ï¼Œè¿™ä¸ªå›è°ƒæ˜¯æ‰“å° `res`ï¼Œ`res` æ˜¯ `p4` çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ `4`
    - å¾®é˜Ÿåˆ—ï¼š `3` `4`
    - è¾“å‡ºï¼š `0` `1` `2`
15. è¾“å‡º 3ï¼Œ`p3` çš„çŠ¶æ€å˜ä¸º `fulfilled`ï¼ŒæŠŠ `p3.then()` çš„å›è°ƒåŠ å…¥åˆ°å¾®é˜Ÿåˆ—
    - å¾®é˜Ÿåˆ—ï¼š `4` `5`
    - è¾“å‡ºï¼š `0` `1` `2` `3`
16. è¾“å‡º 4, `pres` çš„çŠ¶æ€å˜ä¸º `fulfilled`
    - å¾®é˜Ÿåˆ—ï¼š`5`
    - è¾“å‡ºï¼š `0` `1` `2` `3` `4`
17. è¾“å‡º 5, `p5` çš„çŠ¶æ€å˜ä¸º `fulfilled`ï¼ŒæŠŠ `p5.then()` çš„å›è°ƒåŠ å…¥åˆ°å¾®é˜Ÿåˆ—
    - å¾®é˜Ÿåˆ—ï¼š `6`
    - è¾“å‡ºï¼š `0` `1` `2` `3` `4` `5`
18. è¾“å‡º 6ï¼Œ`p6` çš„çŠ¶æ€å˜ä¸º `fulfilled`ï¼Œç»“æŸ

## ä»»åŠ¡é˜Ÿåˆ—å’Œäº‹ä»¶å¾ªç¯

**ä»»åŠ¡é˜Ÿåˆ—**ï¼šJS æ˜¯å•çº¿ç¨‹çš„è¯­è¨€ï¼Œä¸ºäº†å®ç°ä¸é˜»å¡ï¼Œå¯ä»¥ä½¿ç”¨äº‹ä»¶å¾ªç¯ã€‚åœ¨ JS ä¸­ï¼Œæ‰€æœ‰ä»»åŠ¡å¯ä»¥åˆ†æˆä¸¤ç§

- åŒæ­¥ä»»åŠ¡ (synchronous)ï¼šåœ¨ä¸»çº¿ç¨‹ä¸Šæ’é˜Ÿæ‰§è¡Œçš„ä»»åŠ¡ï¼Œåªæœ‰å‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ‰èƒ½æ‰§è¡Œåä¸€ä¸ªä»»åŠ¡
- å¼‚æ­¥ä»»åŠ¡ (asynchronous)ï¼šä¸è¿›å…¥ä¸»çº¿ç¨‹ã€è€Œè¿›å…¥**ä»»åŠ¡é˜Ÿåˆ—** (task queue) çš„ä»»åŠ¡ï¼Œåªæœ‰ä»»åŠ¡é˜Ÿåˆ—é€šçŸ¥ä¸»çº¿ç¨‹ï¼ŒæŸä¸ªå¼‚æ­¥ä»»åŠ¡å¯ä»¥æ‰§è¡Œäº†ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šè¿›å…¥ä¸»çº¿ç¨‹æ‰§è¡Œ **(å¼‚æ­¥æ°¸è¿œå’Œé˜Ÿåˆ—æŒ‚é’©)**

```js
for (let i = 0; i < 3; i++) {
  setTimeout(function () {
    console.log(i);
  }, 1000);
}
console.log(i);
// å…ˆè¾“å‡ºä¸€ä¸ª3ï¼Œæ¥ç€1ç§’ä¹‹åï¼Œä¸€æ¬¡æ€§è¾“å‡ºä¸‰ä¸ª3ã€‚ä¸‰ä¸ªå®šæ—¶å™¨å‡ ä¹åŒæ—¶è®¾ç½®çš„
```

**äº‹ä»¶å¾ªç¯**ï¼šåŒæ­¥ä»»åŠ¡è¿›å…¥ä¸»çº¿ç¨‹ï¼Œå¼‚æ­¥ä»»åŠ¡è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸»çº¿ç¨‹å†…çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¸ºç©ºï¼Œä¼šå»ä»»åŠ¡é˜Ÿåˆ—è¯»å–å¯¹åº”çš„ä»»åŠ¡ï¼Œæ¨å…¥ä¸»çº¿ç¨‹æ‰§è¡Œã€‚ä¸Šè¿°è¿‡ç¨‹çš„ä¸æ–­é‡å¤å°±äº‹ä»¶å¾ªç¯ã€‚

äº‹ä»¶å¾ªç¯åˆå«åšæ¶ˆæ¯å¾ªç¯ï¼Œæ˜¯æµè§ˆå™¨æ¸²æŸ“ä¸»çº¿ç¨‹çš„å·¥ä½œæ–¹å¼ã€‚

åœ¨ Chrome çš„æºç ä¸­ï¼Œå®ƒå¼€å¯ä¸€ä¸ªä¸ä¼šç»“æŸçš„ for å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œï¼Œè€Œå…¶ä»–çº¿ç¨‹åªéœ€è¦åœ¨åˆé€‚çš„æ—¶å€™å°†ä»»åŠ¡åŠ å…¥åˆ°é˜Ÿåˆ—æœ«å°¾å³å¯ã€‚

è¿‡å»æŠŠæ¶ˆæ¯é˜Ÿåˆ—ç®€å•åˆ†ä¸ºå®é˜Ÿåˆ—å’Œå¾®é˜Ÿåˆ—ï¼Œè¿™ç§è¯´æ³•ç›®å‰å·²æ— æ³•æ»¡è¶³å¤æ‚çš„æµè§ˆå™¨ç¯å¢ƒï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä¸€ç§æ›´åŠ çµæ´»å¤šå˜çš„å¤„ç†æ–¹å¼ã€‚

æ ¹æ® W3C å®˜æ–¹çš„è§£é‡Šï¼Œæ¯ä¸ªä»»åŠ¡æœ‰ä¸åŒçš„ç±»å‹ï¼ŒåŒç±»å‹çš„ä»»åŠ¡å¿…é¡»åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸åŒçš„ä»»åŠ¡å¯ä»¥å±äºä¸åŒçš„é˜Ÿåˆ—ã€‚ä¸åŒä»»åŠ¡é˜Ÿåˆ—æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œåœ¨ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œç”±æµè§ˆå™¨è‡ªè¡Œå†³å®šå–å“ªä¸€ä¸ªé˜Ÿåˆ—çš„ä»»åŠ¡ã€‚ä½†æµè§ˆå™¨å¿…é¡»æœ‰ä¸€ä¸ªå¾®é˜Ÿåˆ—ï¼Œå¾®é˜Ÿåˆ—çš„ä»»åŠ¡ä¸€å®šå…·æœ‰æœ€é«˜çš„ä¼˜å…ˆçº§ï¼Œå¿…é¡»ä¼˜å…ˆè°ƒåº¦æ‰§è¡Œã€‚

<img src="https://s2.loli.net/2024/06/13/GM2aciYh7UoKzCN.png" alt="event-loop.png" style="zoom: 50%;" />

**å¼‚æ­¥ä»»åŠ¡**ä¹Ÿå¯ä»¥ç»†åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§å®ä»»åŠ¡ï¼ˆMacroTaskï¼‰ä¹Ÿå« Taskï¼Œä¸€ç§å«å¾®ä»»åŠ¡ï¼ˆMicroTaskï¼‰ã€‚

- å®ä»»åŠ¡ï¼šä¸€èˆ¬ script ä»£ç ï¼Œç”¨æˆ·äº¤äº’äº‹ä»¶ã€setTimeoutã€setIntervalã€requestAnimationFrame (æµè§ˆå™¨ç‹¬æœ‰)ã€I/Oã€UI rendering (æµè§ˆå™¨ç‹¬æœ‰)ç­‰ï¼›ï¼ˆç”¨æˆ·è°ƒç”¨çš„ï¼‰
- å¾®ä»»åŠ¡ï¼šPromise ç›¸å…³ä»»åŠ¡ï¼Œprocess.nextTick (JS è°ƒç”¨çš„)

**ä»»åŠ¡æ‰§è¡Œæµç¨‹**

1. å…ˆæ‰§è¡ŒåŒæ­¥ä»»åŠ¡ï¼Œå…¨éƒ¨æ‰§è¡Œå®Œï¼›
2. æ‰§è¡Œå¾®ä»»åŠ¡ï¼Œå¦‚æœåœ¨æ‰§è¡Œå¾®ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œåˆäº§ç”Ÿäº†å¾®ä»»åŠ¡ï¼Œé‚£ä¹ˆä¼šåŠ å…¥åˆ°é˜Ÿåˆ—çš„æœ«å°¾ï¼Œä¹Ÿä¼šåœ¨è¿™ä¸ªå‘¨æœŸè¢«è°ƒç”¨æ‰§è¡Œï¼Œç›´åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºåœæ­¢ï¼›
3. å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå–ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œï¼›
4. å®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å¾®ä»»åŠ¡ä¼šæ·»åŠ åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…è¿™ä¸ªå®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå†å»å–å¾®ä»»åŠ¡ï¼›å¦‚æœæœ‰å¾®ä»»åŠ¡ï¼Œåˆ™æ‰§è¡Œï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å†å–å®ä»»åŠ¡æ‰§è¡Œã€‚ï¼ˆæ¯æ¬¡è¦æ‰§è¡Œå®é˜Ÿåˆ—é‡Œé¢çš„ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ï¼Œå…ˆçœ‹å¾®é˜Ÿåˆ—é‡Œé¢æ˜¯å¦æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰åˆ™å…ˆæ‰§è¡Œå¾®ä»»åŠ¡ï¼‰

```js
setTimeout(() => {
  console.log(0);
}, 0);

new Promise((resolve, reject) => {
  console.log(1);
  resolve();
})
  .then(() => {
    console.log(2); // è¿™é‡Œçš„å›è°ƒå…ˆæŒ‚è½½åœ¨ Promise å®ä¾‹è‡ªèº«ï¼Œç„¶åé©¬ä¸Šè¢«æ¨å…¥å¾®é˜Ÿåˆ—ï¼Œå®ƒæ²¡æœ‰æ¥å£è¯·æ±‚çš„å»¶è¿Ÿ
    new Promise((resolve, reject) => {
      console.log(3);
      resolve();
    })
      .then(() => {
        console.log(4);
      })
      .then(() => {
        console.log(5);
      });
  })
  .then(() => {
    console.log(6);
  });

new Promise((resolve, reject) => {
  console.log(7);
  resolve();
}).then(() => {
  console.log(8);
});

// è¾“å‡ºç»“æœï¼š 172384650
```

> æ³¨æ„è¿™ä¸ªä¾‹å­ï¼Œå‡è®¾ `getInfo` æ¥å£çš„è¿”å›æ—¶é—´ä¸º 500 ms
>
> å½“ delay å¤§äº 500 æ—¶ï¼Œè¾“å‡ºé¡ºåºä¸º `then` `finally` `setTimeout`ï¼ˆç¬¦åˆé¢„æœŸï¼‰
>
> å½“ delay å°äº 500 æ—¶ï¼Œè¾“å‡ºé¡ºåºä¸º `setTimeout` `then` `finally` ï¼ˆâš ï¸ï¼‰
>
> å› ä¸ºå½“ delay å°äº 500 æ—¶ï¼Œå‡è®¾ delay ä¸º 200
>
> 1. å½“ 200 ms è¿‡å»åï¼Œ`setTimeout` çš„å›è°ƒè¢«æ”¾å…¥å®ä»»åŠ¡é˜Ÿåˆ—ï¼›
> 2. äº‹ä»¶å¾ªç¯æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå‘ç°ä¸ºç©ºï¼ˆæ­¤æ—¶ï¼Œ`getInfo` æ¥å£æœªå®Œæˆï¼Œ`then` å’Œ `finally` ä¸­çš„å›è°ƒè¿˜æ²¡æœ‰è¢«æ¨å…¥å¾®é˜Ÿåˆ—ï¼‰
> 3. äº‹ä»¶å¾ªç¯å¤„ç†å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œ `setTimeout` çš„å›è°ƒ
> 4. `getInfo` æ¥å£è¯·æ±‚æœ€ç»ˆå®Œæˆ
> 5. `then()` å’Œ `finally()` çš„å›è°ƒè¢«æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—å¹¶æ‰§è¡Œ

```js
init() {
  getInfo().then((res: any) => {
    console.log('ğŸš€ğŸš€ğŸš€ then: ');
  }).finally(() => {
    console.log('ğŸš€ğŸš€ğŸš€ finally: ');
  });

  setTimeout(() => {
    console.log('ğŸš€ğŸš€ğŸš€ : setTimeout');
  }, delay);
}

init()
```

## æ‰‹å†™ Promise

```js :collapsed-lines
/** å®šä¹‰ Promise ç±»*/
class MyPromise {
  // æ„é€ å‡½æ•°ï¼šæ¥æ”¶ä¸€ä¸ªæ‰§è¡Œå™¨å‡½æ•° executor
  constructor(executor) {
    // åˆå§‹åŒ– Promise çš„çŠ¶æ€å’Œå€¼
    this.status = "pending"; // åˆå§‹çŠ¶æ€ï¼šç­‰å¾…ä¸­
    this.value = undefined; // æˆåŠŸå€¼ï¼šå½“ Promise è¢« resolve æ—¶å­˜å‚¨çš„å€¼
    this.reason = undefined; // å¤±è´¥åŸå› ï¼šå½“ Promise è¢« reject æ—¶å­˜å‚¨çš„é”™è¯¯ä¿¡æ¯
    this.onFulfilledCallbacks = []; // æˆåŠŸå›è°ƒé˜Ÿåˆ—ï¼šå­˜å‚¨æ‰€æœ‰ then æ–¹æ³•ä¸­æ³¨å†Œçš„æˆåŠŸå›è°ƒå‡½æ•°
    this.onRejectedCallbacks = []; // å¤±è´¥å›è°ƒé˜Ÿåˆ—ï¼šå­˜å‚¨æ‰€æœ‰ then æ–¹æ³•ä¸­æ³¨å†Œçš„å¤±è´¥å›è°ƒå‡½æ•°

    // å®šä¹‰ resolve æ–¹æ³•ï¼šå°† Promise çŠ¶æ€ä» pending å˜ä¸º fulfilled
    const resolve = (value) => {
      // å¦‚æœçŠ¶æ€ä¸æ˜¯ pendingï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œç¡®ä¿ Promise çŠ¶æ€åªèƒ½æ”¹å˜ä¸€æ¬¡
      if (this.status !== "pending") return;

      // ä½¿ç”¨ queueMicrotask ç¡®ä¿å›è°ƒå‡½æ•°åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰§è¡Œï¼Œæ¨¡æ‹Ÿ Promise çš„å¼‚æ­¥ç‰¹æ€§
      queueMicrotask(() => {
        // å¦‚æœ resolve çš„å€¼æ˜¯ä¸€ä¸ª Promise å®ä¾‹ï¼Œåˆ™éœ€è¦ç­‰å¾…è¯¥ Promise å®Œæˆ
        if (value instanceof MyPromise) {
          value.then(resolve, reject);
        } else {
          // å°†çŠ¶æ€æ”¹ä¸º fulfilledï¼Œå¹¶å­˜å‚¨æˆåŠŸå€¼
          this.status = "fulfilled";
          this.value = value;
          // æ‰§è¡Œæ‰€æœ‰æ³¨å†Œçš„æˆåŠŸå›è°ƒå‡½æ•°
          this.onFulfilledCallbacks.forEach((fn) => fn(value));
        }
      });
    };

    // å®šä¹‰ reject æ–¹æ³•ï¼šå°† Promise çŠ¶æ€ä» pending å˜ä¸º rejected
    const reject = (reason) => {
      // å¦‚æœçŠ¶æ€ä¸æ˜¯ pendingï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œç¡®ä¿ Promise çŠ¶æ€åªèƒ½æ”¹å˜ä¸€æ¬¡
      if (this.status !== "pending") return;

      // ä½¿ç”¨ queueMicrotask ç¡®ä¿å›è°ƒå‡½æ•°åœ¨å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰§è¡Œ
      queueMicrotask(() => {
        // å°†çŠ¶æ€æ”¹ä¸º rejectedï¼Œå¹¶å­˜å‚¨å¤±è´¥åŸå› 
        this.status = "rejected";
        this.reason = reason;
        // æ‰§è¡Œæ‰€æœ‰æ³¨å†Œçš„å¤±è´¥å›è°ƒå‡½æ•°
        this.onRejectedCallbacks.forEach((fn) => fn(reason));
      });
    };

    // æ‰§è¡Œ executor å‡½æ•°ï¼Œå¹¶ä¼ å…¥ resolve å’Œ reject æ–¹æ³•
    try {
      executor(resolve, reject);
    } catch (err) {
      // å¦‚æœ executor æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™è°ƒç”¨ reject æ–¹æ³•
      reject(err);
    }
  }

  /**
   * then æ–¹æ³•ï¼šæ³¨å†Œ Promise çŠ¶æ€æ”¹å˜åçš„å›è°ƒå‡½æ•°
   * å®ä¾‹æ–¹æ³•ï¼šé€šè¿‡ Promise å®ä¾‹è°ƒç”¨ï¼Œä¾‹å¦‚ promise.then(onFulfilled, onRejected)
   *
   * @param {Function} onFulfilled - æˆåŠŸæ—¶çš„å›è°ƒå‡½æ•°ï¼Œæ¥æ”¶ Promise çš„è§£å†³å€¼
   * @param {Function} onRejected - å¤±è´¥æ—¶çš„å›è°ƒå‡½æ•°ï¼Œæ¥æ”¶ Promise çš„æ‹’ç»åŸå› 
   * @returns {MyPromise} è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œå®ç°é“¾å¼è°ƒç”¨
   *
   * ä½¿ç”¨ç¤ºä¾‹ï¼š
   * new MyPromise(resolve => resolve(42))
   *   .then(value => value * 2)
   *   .then(value => console.log(value)) // è¾“å‡º: 84
   */
  then(onFulfilled, onRejected) {
    // è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œå®ç°é“¾å¼è°ƒç”¨
    return new MyPromise((resolve, reject) => {
      // å®šä¹‰å¤„ç†æˆåŠŸçš„å›è°ƒå‡½æ•°
      const handleFulfilled = (value) => {
        try {
          // å¦‚æœ onFulfilled æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™æ‰§è¡Œå®ƒå¹¶å¤„ç†å…¶è¿”å›å€¼
          if (typeof onFulfilled === "function") {
            const result = onFulfilled(value);
            // å¤„ç† then æ–¹æ³•è¿”å›çš„ Promise æˆ–å…¶ä»–å€¼
            resolvePromise(result, resolve, reject);
          } else {
            // å¦‚æœ onFulfilled ä¸æ˜¯å‡½æ•°ï¼Œåˆ™ç›´æ¥å°†å€¼ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Promise
            resolve(value);
          }
        } catch (err) {
          // å¦‚æœå›è°ƒå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™è°ƒç”¨ reject æ–¹æ³•
          reject(err);
        }
      };

      // å®šä¹‰å¤„ç†å¤±è´¥çš„å›è°ƒå‡½æ•°
      const handleRejected = (reason) => {
        try {
          // å¦‚æœ onRejected æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™æ‰§è¡Œå®ƒå¹¶å¤„ç†å…¶è¿”å›å€¼
          if (typeof onRejected === "function") {
            const result = onRejected(reason);
            // å¤„ç† then æ–¹æ³•è¿”å›çš„ Promise æˆ–å…¶ä»–å€¼
            resolvePromise(result, resolve, reject);
          } else {
            // å¦‚æœ onRejected ä¸æ˜¯å‡½æ•°ï¼Œåˆ™ç›´æ¥å°†é”™è¯¯ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Promise
            reject(reason);
          }
        } catch (err) {
          // å¦‚æœå›è°ƒå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™è°ƒç”¨ reject æ–¹æ³•
          reject(err);
        }
      };

      // æ ¹æ®å½“å‰ Promise çš„çŠ¶æ€æ‰§è¡Œä¸åŒçš„é€»è¾‘
      if (this.status === "fulfilled") {
        // å¦‚æœå½“å‰ Promise å·²ç»æ˜¯ fulfilled çŠ¶æ€ï¼Œåˆ™å¼‚æ­¥æ‰§è¡ŒæˆåŠŸå›è°ƒ
        queueMicrotask(() => handleFulfilled(this.value));
      } else if (this.status === "rejected") {
        // å¦‚æœå½“å‰ Promise å·²ç»æ˜¯ rejected çŠ¶æ€ï¼Œåˆ™å¼‚æ­¥æ‰§è¡Œå¤±è´¥å›è°ƒ
        queueMicrotask(() => handleRejected(this.reason));
      } else {
        // å¦‚æœå½“å‰ Promise æ˜¯ pending çŠ¶æ€ï¼Œåˆ™å°†å›è°ƒå‡½æ•°æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­
        this.onFulfilledCallbacks.push(handleFulfilled);
        this.onRejectedCallbacks.push(handleRejected);
      }
    });
  }

  /**
   * catch æ–¹æ³•ï¼šæ³¨å†Œ Promise å¤±è´¥æ—¶çš„å›è°ƒå‡½æ•°
   * å®ä¾‹æ–¹æ³•ï¼šé€šè¿‡ Promise å®ä¾‹è°ƒç”¨ï¼Œä¾‹å¦‚ promise.catch(onRejected)
   *
   * @param {Function} onRejected - å¤±è´¥æ—¶çš„å›è°ƒå‡½æ•°ï¼Œæ¥æ”¶ Promise çš„æ‹’ç»åŸå› 
   * @returns {MyPromise} è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œå®ç°é“¾å¼è°ƒç”¨
   *
   * ä½¿ç”¨ç¤ºä¾‹ï¼š
   * new MyPromise((_, reject) => reject(new Error('å‡ºé”™äº†')))
   *   .catch(err => console.error(err)) // è¾“å‡º: Error: å‡ºé”™äº†
   */
  catch(onRejected) {
    return this.then(undefined, onRejected);
  }

  /**
   * finally æ–¹æ³•ï¼šæ— è®º Promise æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½ä¼šæ‰§è¡Œçš„å›è°ƒå‡½æ•°
   * å®ä¾‹æ–¹æ³•ï¼šé€šè¿‡ Promise å®ä¾‹è°ƒç”¨ï¼Œä¾‹å¦‚ promise.finally(callback)
   *
   * @param {Function} callback - æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½ä¼šæ‰§è¡Œçš„å›è°ƒå‡½æ•°
   * @returns {MyPromise} è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œå®ç°é“¾å¼è°ƒç”¨
   *
   * ä½¿ç”¨ç¤ºä¾‹ï¼š
   * new MyPromise(resolve => resolve(42))
   *   .then(value => console.log(value)) // è¾“å‡º: 42
   *   .finally(() => console.log('å®Œæˆ')) // è¾“å‡º: å®Œæˆ
   */
  finally(callback) {
    return this.then(
      // æˆåŠŸæ—¶æ‰§è¡Œ callback å¹¶è¿”å›åŸå€¼
      (value) => {
        callback();
        return value;
      },
      // å¤±è´¥æ—¶æ‰§è¡Œ callback å¹¶æŠ›å‡ºåŸé”™è¯¯
      (reason) => {
        callback();
        throw reason;
      }
    );
  }

  /**
   * é™æ€æ–¹æ³•ï¼šç›´æ¥é€šè¿‡ç±»åè°ƒç”¨çš„æ–¹æ³•ï¼Œä¸éœ€è¦åˆ›å»ºç±»çš„å®ä¾‹
   * ä¾‹å¦‚ï¼šMyPromise.resolve(42) è€Œä¸æ˜¯ new MyPromise(...).resolve(42)
   *
   * é™æ€ resolve æ–¹æ³•ï¼šåˆ›å»ºä¸€ä¸ªå·²è§£å†³çš„ Promise
   * ä½¿ç”¨åœºæ™¯ï¼šå½“éœ€è¦å°†ä¸€ä¸ªå€¼è½¬æ¢ä¸º Promise æ—¶
   * ç¤ºä¾‹ï¼šMyPromise.resolve(42).then(value => console.log(value)) // è¾“å‡º: 42
   */
  static resolve(value) {
    return new MyPromise((resolve) => resolve(value));
  }

  /**
   * é™æ€ reject æ–¹æ³•ï¼šåˆ›å»ºä¸€ä¸ªå·²æ‹’ç»çš„ Promise
   * ä½¿ç”¨åœºæ™¯ï¼šå½“éœ€è¦åˆ›å»ºä¸€ä¸ªè¡¨ç¤ºé”™è¯¯çš„ Promise æ—¶
   * ç¤ºä¾‹ï¼šMyPromise.reject(new Error('å‡ºé”™äº†')).catch(err => console.error(err))
   */
  static reject(reason) {
    return new MyPromise((_, reject) => reject(reason));
  }

  /**
   * é™æ€ all æ–¹æ³•ï¼šç­‰å¾…æ‰€æœ‰ Promise å®Œæˆï¼Œè¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç»“æœçš„æ•°ç»„
   * ä½¿ç”¨åœºæ™¯ï¼šå½“éœ€è¦å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå¼‚æ­¥æ“ä½œï¼Œå¹¶ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆæ—¶
   * ç‰¹ç‚¹ï¼šå¦‚æœä»»ä½•ä¸€ä¸ª Promise å¤±è´¥ï¼Œæ•´ä¸ª all æ–¹æ³•è¿”å›çš„ Promise ä¹Ÿä¼šå¤±è´¥
   * ç¤ºä¾‹ï¼š
   * MyPromise.all([
   *   fetch('/api/users'),
   *   fetch('/api/posts')
   * ]).then(([users, posts]) => console.log(users, posts))
   */
  static all(promises) {
    return new MyPromise((resolve, reject) => {
      const results = []; // å­˜å‚¨æ‰€æœ‰ Promise çš„ç»“æœ
      let count = 0; // è®¡æ•°å™¨ï¼Œè®°å½•å·²å®Œæˆçš„ Promise æ•°é‡

      // éå†æ‰€æœ‰ Promise
      promises.forEach((p, i) => {
        // ç¡®ä¿æ¯ä¸ªé¡¹éƒ½æ˜¯ Promise å®ä¾‹
        MyPromise.resolve(p).then((value) => {
          // å°†ç»“æœå­˜å‚¨åœ¨å¯¹åº”ä½ç½®ï¼Œä¿æŒé¡ºåº
          results[i] = value;
          count++;
          // å½“æ‰€æœ‰ Promise éƒ½å®Œæˆæ—¶ï¼Œè¿”å›ç»“æœæ•°ç»„
          if (count === promises.length) {
            resolve(results);
          }
        }, reject); // å¦‚æœä»»ä½•ä¸€ä¸ª Promise å¤±è´¥ï¼Œåˆ™æ•´ä¸ª all æ–¹æ³•å¤±è´¥
      });
    });
  }

  /**
   * é™æ€ race æ–¹æ³•ï¼šè¿”å›ç¬¬ä¸€ä¸ªå®Œæˆçš„ Promise çš„ç»“æœ
   * ä½¿ç”¨åœºæ™¯ï¼šå½“éœ€è¦ä»å¤šä¸ªå¼‚æ­¥æ“ä½œä¸­è·å–æœ€å¿«å®Œæˆçš„ç»“æœæ—¶
   * ç‰¹ç‚¹ï¼šæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œåªè¦æœ‰ä¸€ä¸ª Promise å®Œæˆï¼Œrace æ–¹æ³•å°±ä¼šè¿”å›å…¶ç»“æœ
   * ç¤ºä¾‹ï¼š
   * MyPromise.race([
   *   fetch('/api/fast-server'),
   *   fetch('/api/slow-server')
   * ]).then(result => console.log('æœ€å¿«è¿”å›çš„ç»“æœ:', result))
   */
  static race(promises) {
    return new MyPromise((resolve, reject) => {
      // éå†æ‰€æœ‰ Promise
      promises.forEach((p) => {
        // ç¡®ä¿æ¯ä¸ªé¡¹éƒ½æ˜¯ Promise å®ä¾‹
        MyPromise.resolve(p).then(resolve, reject); // ç¬¬ä¸€ä¸ªå®Œæˆçš„ Promise å°†å†³å®šæ•´ä¸ª race çš„ç»“æœ
      });
    });
  }
}

/** å†…éƒ¨å·¥å…·å‡½æ•°ï¼šå¤„ç† then æ–¹æ³•è¿”å›å€¼ä¸º Promise çš„æƒ…å†µ */
function resolvePromise(result, resolve, reject) {
  // å¦‚æœè¿”å›å€¼æ˜¯ Promise å®ä¾‹ï¼Œåˆ™ç­‰å¾…å…¶å®Œæˆ
  if (result instanceof MyPromise) {
    result.then(resolve, reject);
  } else {
    // å¦‚æœè¿”å›å€¼ä¸æ˜¯ Promise å®ä¾‹ï¼Œåˆ™ç›´æ¥ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Promise
    resolve(result);
  }
}
```
